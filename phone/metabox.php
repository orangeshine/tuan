<?php
$new_meta_boxes =
array(
    "lunbotu" => array(
        "name" => "_meta_lunbotu",
        "std" => "",
        "title" => "产品详情页轮播图片URL",
        "type"=>"mudi"),

    "lunbotu2" => array(
        "name" => "_meta_lunbotu2",
        "std" => "",
        "title" => "",
        "type"=>"mudi2"),

    "lunbotu3" => array(
        "name" => "_meta_lunbotu3",
        "std" => "",
        "title" => "",
        "type"=>"mudi3"),

    "carousel" => array(
        "name" => "_meta_carousel",
        "std" => "",
        "title" => "首页图片轮播图片URL",
        "type"=>"mudi"),

    "jiage" => array(
        "name" => "_meta_jiage",
        "std" => "",
        "title" => "福利产品价格",
        "type"=>"numbers"),

    "jiage3" => array(
        "name" => "_meta_qijia3",
        "std" => "",
        "title" => "团建产品价格",
        "type"=>"numbers"),

    "label1" => array(
        "name" => "_meta_label1",
        "std" => "",
        "title" => "团建标签1",
        "type"=>"single"),

    "label2" => array(
        "name" => "_meta_label2",
        "std" => "",
        "title" => "团建标签2",
        "type"=>"single"),

    "label3" => array(
        "name" => "_meta_label3",
        "std" => "",
        "title" => "团建标签3",
        "type"=>"single"),

    "fubiaoti" => array(
        "name" => "_meta_fubiaoti",
        "std" => "",
        "title" => "副标题",
        "type"=>"longsingle"),

    "shtd" => array(
        "name" => "_meta_shtd",
        "std" => "",
        "title" => "关键词",
        "type"=>"shihe"),
    
    "shtd1" => array(
        "name" => "_meta_shtd1",
        "std" => "",
        "title" => "关键词2",
        "type"=>"shihe"),

    "shtd2" => array(
        "name" => "_meta_shtd2",
        "std" => "",
        "title" => "适合场景",
        "type"=>"shihe"),

    "muididi" => array(
        "name" => "_meta_muididi",
        "std" => "",
        "title" => "目的地",
        "type"=>"single"),

    "tianshu" => array(
        "name" => "_meta_tianshu",
        "std" => "",
        "title" => "活动天数",
        "type"=>"single"),

    "renshu" => array(
        "name" => "_meta_renshu",
        "std" => "",
        "title" => "人数范围",
        "type"=>"single"),


    "checkbox" => array(
        "name" => "_meta_eidtor",
        "std" => '',
        "title" => "活动意义",
        "type"=>"editor"),

    "day1content" => array(
        "name" => "day1content",
        "std" => "",
        "title" => "团建内容",
        "type"=>"editor"),

    "lxjs" => array(
        "name" => "_meta_lxjs",
        "std" => "",
        "title" => "路线介绍",
        "type"=>"editor"),

    "fysm" => array(
        "name" => "_meta_fysm",
        "std" => "",
        "title" => "费用说明",
        "type"=>"editor"),

    "ydxz" => array(
        "name" => "_meta_ydxz",
        "std" => "",
        "title" => "预约说明",
        "type"=>"editor"),

    "tbtx" => array(
        "name" => "_meta_tbtx",
        "std" => "",
        "title" => "团建贴士",
        "type"=>"editor"),

    // "day1" => array(
    //     "name" => "_meta_day1",
    //     "std" => "",
    //     "title" => "第1天",
    //     "type"=>"title"),

    

    // "food" => array(
    //     "name" => "_meta_food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "food2" => array(
    //     "name" => "_meta_food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "food3" => array(
    //     "name" => "_meta_food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "zhusu" => array(
    //     "name" => "_meta_zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "jiaotong" => array(
    //     "name" => "_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day2" => array(
    //     "name" => "_meta_day2",
    //     "std" => "",
    //     "title" => "第2天",
    //     "type"=>"title"),

    // "day2content" => array(
    //     "name" => "day2content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day2food" => array(
    //     "name" => "_meta_day2food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day2food2" => array(
    //     "name" => "_meta_day2food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day2food3" => array(
    //     "name" => "_meta_day2food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day2zhusu" => array(
    //     "name" => "_meta_day2zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day2jiaotong" => array(
    //     "name" => "day2_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day3" => array(
    //     "name" => "_meta_day3",
    //     "std" => "",
    //     "title" => "第3天",
    //     "type"=>"title"),

    // "day3content" => array(
    //     "name" => "day3content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day3food" => array(
    //     "name" => "_meta_day3food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day3food2" => array(
    //     "name" => "_meta_day3food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day3food3" => array(
    //     "name" => "_meta_day3food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day3zhusu" => array(
    //     "name" => "_meta_day3zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day3jiaotong" => array(
    //     "name" => "day3_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day4" => array(
    //     "name" => "_meta_day4",
    //     "std" => "",
    //     "title" => "第4天",
    //     "type"=>"title"),

    // "day4content" => array(
    //     "name" => "day4content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day4food" => array(
    //     "name" => "_meta_day4food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day4food2" => array(
    //     "name" => "_meta_day4food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day4food3" => array(
    //     "name" => "_meta_day4food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day4zhusu" => array(
    //     "name" => "_meta_day4zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day4jiaotong" => array(
    //     "name" => "day4_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day5" => array(
    //     "name" => "_meta_day5",
    //     "std" => "",
    //     "title" => "第5天",
    //     "type"=>"title"),

    // "day5content" => array(
    //     "name" => "day5content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day5food" => array(
    //     "name" => "_meta_day5food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day5food2" => array(
    //     "name" => "_meta_day5food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day5food3" => array(
    //     "name" => "_meta_day5food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day5zhusu" => array(
    //     "name" => "_meta_day5zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day5jiaotong" => array(
    //     "name" => "day5_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day6" => array(
    //     "name" => "_meta_day2",
    //     "std" => "",
    //     "title" => "第6天",
    //     "type"=>"title"),

    // "day6content" => array(
    //     "name" => "day6content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day6food" => array(
    //     "name" => "_meta_day6food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day6food2" => array(
    //     "name" => "_meta_day6food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day6food3" => array(
    //     "name" => "_meta_day6food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day6zhusu" => array(
    //     "name" => "_meta_day6zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day6jiaotong" => array(
    //     "name" => "day6_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    // "day7" => array(
    //     "name" => "_meta_day7",
    //     "std" => "",
    //     "title" => "第7天",
    //     "type"=>"title"),

    // "day7content" => array(
    //     "name" => "day7content",
    //     "std" => "",
    //     "title" => "内容",
    //     "type"=>"editor"),

    // "day7food" => array(
    //     "name" => "_meta_day7food",
    //     "std" => "",
    //     "title" => "用餐(早中晚三餐，含或无)",
    //     "type"=>"mudi"),

    // "day7food2" => array(
    //     "name" => "_meta_day7food2",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi2"),

    // "day7food3" => array(
    //     "name" => "_meta_day7food3",
    //     "std" => "",
    //     "title" => "",
    //     "type"=>"mudi3"),

    // "day7zhusu" => array(
    //     "name" => "_meta_day7zhusu",
    //     "std" => "",
    //     "title" => "住宿",
    //     "type"=>"single"),

    // "day7jiaotong" => array(
    //     "name" => "day7_meta_jiaotong",
    //     "std" => "",
    //     "title" => "交通",
    //     "type"=>"single"),

    /*"keywords" => array(
        "name" => "_meta_keywords",
        "std" => "",
        "title" => "关键字",
        "type"=>"text"),

    "description" => array(
        "name" => "_meta_description",
        "std" => "",
        "title" => "描述",
        "type"=>"textarea"),

    "category" => array(
        "name" => "_meta_cate",
        "std" => "",
        "title" => "选择分类",
        "subtype"=> "cat",
        "type"=>"dropdown"),

    "radio" => array(
        "name" => "_meta_radio",
        "std" => 1,
        "title" => "单选框",
        "buttons" => array('Yes','No'),
        "type"=>"radio"),

    "checkbox" => array(
        "name" => "_meta_checkbox",
        "std" => 1,
        "title" => "复选框",
        "type"=>"checkbox"), */

);


function new_meta_boxes() {
    global $post, $new_meta_boxes;
    foreach($new_meta_boxes as $meta_box) {
        //获取保存的是
        $meta_box_value = get_post_meta($post->ID, $meta_box['name'].'_value', true);
        if($meta_box_value != "")
            $meta_box['std'] = $meta_box_value;//将默认值替换为以保存的值

        echo'<input type="hidden" name="'.$meta_box['name'].'_noncename" id="'.$meta_box['name'].'_noncename" value="'.wp_create_nonce( plugin_basename(__FILE__) ).'" />';
        //通过选择类型输出不同的html代码
        switch ( $meta_box['type'] ){
            case 'title':
                echo'<br /><h1>'.$meta_box['title'].'</h1><br />';
                break;
            case 'numbers':
               echo'<h4>'.$meta_box['title'].'</h4>';
               echo '<input type="number" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br />';
               break;
             case 'single':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br />';
                break;
            case 'longsingle':
               echo'<h4>'.$meta_box['title'].'</h4>';
               echo '<input type="text" size="100" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br />';
               break;
            case 'zdjg':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="number" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'shihe':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'shihe2':
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br />';
                break;
            case 'mudi':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'mudi2':
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'mudi3':
                echo '<input type="text" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br/>';
                break;
            case 'xingcheng':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="text" size="70" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br />';
                break;
            case 'qiren':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<input type="number" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'qiren2':
                echo '<input type="number" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" />';
                break;
            case 'qiren3':
                echo '<input type="number" size="20" name="'.$meta_box['name'].'_value" value="'.$meta_box['std'].'" /><br/>';
                break;
            case 'textarea':
                echo'<h4>'.$meta_box['title'].'</h4>';
                echo '<textarea cols="60" rows="3" name="'.$meta_box['name'].'_value">'.$meta_box['std'].'</textarea><br />';
                break;
            case 'dropdown':
                echo'<h4>'.$meta_box['title'].'</h4>';
                if($meta_box['subtype'] == 'cat'){
                    $select = 'Select category';
                    $entries = get_categories('title_li=&orderby=name&hide_empty=0');//获取分类
                }
                echo '<p><select name="'.$meta_box['name'].'_value"> ';
                echo '<option value="">'.$select .'</option>  ';
                foreach ($entries as $key => $entry){
                    $id = $entry->term_id;
                    $title = $entry->name;
                    if ( $meta_box['std'] == $id ){
                        $selected = "selected='selected'";
                    }else{
                        $selected = "";
                    }
                    echo "<option $selected value='". $id."'>". $title."</option>";
                }
                echo '</select><br />';
                break;
            case 'radio':
                echo'<h4>'.$meta_box['title'].'</h4>';
                $counter = 1;
                foreach( $meta_box['buttons'] as $radiobutton ) {
                    $checked ="";
                    if(isset($meta_box['std']) && $meta_box['std'] == $counter) {
                        $checked = 'checked = "checked"';
                    }
                    echo '<input '.$checked.' type="radio" class="kcheck" value="'.$counter.'" name="'.$meta_box['name'].'_value"/>'.$radiobutton;
                    $counter++;
                }
                break;
            case 'checkbox':
                echo'<h4>'.$meta_box['title'].'</h4>';
                if( isset($meta_box['std']) && $meta_box['std'] == 'true' )
                    $checked = 'checked = "checked"';
                else
                    $checked  = '';
                echo '<input type="checkbox" name="'.$meta_box['name'].'_value" value="true"  '.$checked.' />';
                break;
            //编辑器
            case 'editor':
                echo'<h4>'.$meta_box['title'].'</h4>';
                wp_editor( $meta_box['std'], $meta_box['name'].'_value' );
                //带配置参数
                /*wp_editor($meta_box['std'],$meta_box['name'].'_value', $settings = array(quicktags=>0,//取消html模式
                    tinymce=>1,//可视化模式
                    media_buttons=>0,//取消媒体上传
                    textarea_rows=>5,//行数设为5
                    editor_class=>"textareastyle") ); */
            break;

        }
    }
}

function create_meta_box() {
    global $theme_name;

    if ( function_exists('add_meta_box') ) {
        add_meta_box( 'new-meta-boxes', '团建活动', 'new_meta_boxes', 'post', 'normal', 'high' );
    }
}
function save_postdata( $post_id ) {
    global $post, $new_meta_boxes;

    foreach($new_meta_boxes as $meta_box) {
        if ( !wp_verify_nonce( $_POST[$meta_box['name'].'_noncename'], plugin_basename(__FILE__) ))  {
            return $post_id;
        }

        if ( 'page' == $_POST['post_type'] ) {
            if ( !current_user_can( 'edit_page', $post_id ))
                return $post_id;
        }
        else {
            if ( !current_user_can( 'edit_post', $post_id ))
                return $post_id;
        }

        $data = $_POST[$meta_box['name'].'_value'];

        if(get_post_meta($post_id, $meta_box['name'].'_value') == "")
            add_post_meta($post_id, $meta_box['name'].'_value', $data, true);
        elseif($data != get_post_meta($post_id, $meta_box['name'].'_value', true))
            update_post_meta($post_id, $meta_box['name'].'_value', $data);
        elseif($data == "")
            delete_post_meta($post_id, $meta_box['name'].'_value', get_post_meta($post_id, $meta_box['name'].'_value', true));
    }
}

add_action('admin_menu', 'create_meta_box');
add_action('save_post', 'save_postdata');
?>
